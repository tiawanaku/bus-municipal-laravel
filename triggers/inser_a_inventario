DELIMITER $$

CREATE TRIGGER set_estados_on_insert
BEFORE INSERT ON inventario_talonarios
FOR EACH ROW
BEGIN
    DECLARE lotes_activos_preferencial INT;
    DECLARE lotes_activos_regular INT;

    -- Contar lotes preferenciales activos
    SELECT COUNT(*) INTO lotes_activos_preferencial
    FROM inventario_talonarios
    WHERE cantidad_restante_preferencial > 0 AND estado_preferencial = 1;

    -- Contar lotes regulares activos
    SELECT COUNT(*) INTO lotes_activos_regular
    FROM inventario_talonarios
    WHERE cantidad_restante_regular > 0 AND estado_regular = 1;

    -- Asignar estado_preferencial según si hay otros activos
    IF lotes_activos_preferencial = 0 AND NEW.cantidad_restante_preferencial > 0 THEN
        SET NEW.estado_preferencial = 1; -- asignable
    ELSEIF NEW.cantidad_restante_preferencial > 0 THEN
        SET NEW.estado_preferencial = 2; -- no asignable
    ELSE
        SET NEW.estado_preferencial = 0; -- inactivo o sin preferenciales
    END IF;

    -- Asignar estado_regular según si hay otros activos
    IF lotes_activos_regular = 0 AND NEW.cantidad_restante_regular > 0 THEN
        SET NEW.estado_regular = 1; -- asignable
    ELSEIF NEW.cantidad_restante_regular > 0 THEN
        SET NEW.estado_regular = 2; -- no asignable
    ELSE
        SET NEW.estado_regular = 0; -- inactivo o sin regulares
    END IF;

END$$

DELIMITER ;
