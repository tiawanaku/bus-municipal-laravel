DELIMITER //

CREATE PROCEDURE registrar_formulario_recaudo (
    IN p_bus_id INT,
    IN p_conductor_id INT,
    IN p_anfitrion_id INT,
    IN p_rutas VARCHAR(100),
    IN p_horario VARCHAR(50),
    IN p_cantidad_ventas_regulares INT,
    IN p_rango_inicial_regulares INT,
    IN p_cantidad_ventas_preferenciales INT,
    IN p_rango_inicial_preferencial INT,
    IN p_n_ficha VARCHAR(50)
)
BEGIN
    DECLARE v_rango_final_regulares INT DEFAULT 0;
    DECLARE v_rango_final_preferencial INT DEFAULT 0;
    DECLARE v_monto_recaudado_regular DECIMAL(10,2) DEFAULT 0.00;
    DECLARE v_monto_recaudado_preferencial DECIMAL(10,2) DEFAULT 0.00;
    DECLARE v_total_recaudo_regular_preferencial DECIMAL(10,2) DEFAULT 0.00;

    -- Calcular rangos y montos si hay ventas regulares
    IF p_cantidad_ventas_regulares > 0 THEN
        SET v_rango_final_regulares = p_rango_inicial_regulares + p_cantidad_ventas_regulares - 1;
        SET v_monto_recaudado_regular = p_cantidad_ventas_regulares * 1.50;
    END IF;

    -- Calcular rangos y montos si hay ventas preferenciales
    IF p_cantidad_ventas_preferenciales > 0 THEN
        SET v_rango_final_preferencial = p_rango_inicial_preferencial + p_cantidad_ventas_preferenciales - 1;
        SET v_monto_recaudado_preferencial = p_cantidad_ventas_preferenciales * 1.00;
    END IF;

    -- Calcular total
    SET v_total_recaudo_regular_preferencial = v_monto_recaudado_regular + v_monto_recaudado_preferencial;

    -- Insertar datos en formulario_recaudo
    INSERT INTO formulario_recaudo (
        bus_id,
        conductor_id,
        rutas,
        horario,
        cantidad_ventas_regulares,
        rango_inicial_regulares,
        rango_final_regulares,
        monto_recaudado_regular,
        cantidad_ventas_preferenciales,
        rango_inicial_preferencial,
        rango_final_preferencial,
        monto_recaudado_preferencial,
        total_recaudo_regular_preferencial,
        n_ficha,
        created_at,
        updated_at
    ) VALUES (
        p_bus_id,
        p_conductor_id,
        p_rutas,
        p_horario,
        p_cantidad_ventas_regulares,
        p_rango_inicial_regulares,
        v_rango_final_regulares,
        v_monto_recaudado_regular,
        p_cantidad_ventas_preferenciales,
        p_rango_inicial_preferencial,
        v_rango_final_preferencial,
        v_monto_recaudado_preferencial,
        v_total_recaudo_regular_preferencial,
        p_n_ficha,
        NOW(),
        NOW()
    );

    -- Descontar boletos del anfitriÃ³n si hay ventas
    IF p_cantidad_ventas_regulares > 0 OR p_cantidad_ventas_preferenciales > 0 THEN
        UPDATE entrega_talonarios_anfitrion
        SET
            total_boletos_regulares = total_boletos_regulares - p_cantidad_ventas_regulares,
            total_boletos_preferenciales = total_boletos_preferenciales - p_cantidad_ventas_preferenciales
        WHERE anfitrion_id = p_anfitrion_id;
    END IF;
END //

DELIMITER ;
