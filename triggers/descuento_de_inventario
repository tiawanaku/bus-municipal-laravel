DELIMITER $$

CREATE TRIGGER restar_cantidades_talonarios
AFTER INSERT ON entrega_talonarios
FOR EACH ROW
BEGIN
    DECLARE id_preferencial_actual INT;
    DECLARE id_regular_actual INT;

    -- Obtener el ID del lote preferencial activo
    SELECT id INTO id_preferencial_actual
    FROM inventario_talonarios
    WHERE cajero_id = NEW.cajero_id AND estado_preferencial = 1
    LIMIT 1;

    -- Obtener el ID del lote regular activo
    SELECT id INTO id_regular_actual
    FROM inventario_talonarios
    WHERE cajero_id = NEW.cajero_id AND estado_regular = 1
    LIMIT 1;

    -- Preferenciales: solo descontar del lote con estado 1
    IF NEW.cantidad_preferenciales REGEXP '^[0-9]+$' THEN
        UPDATE inventario_talonarios
        SET cantidad_restante_preferencial = cantidad_restante_preferencial - CAST(NEW.cantidad_preferenciales AS UNSIGNED)
        WHERE id = id_preferencial_actual;

        -- Si la cantidad restante llega a 0, marcar como agotado (estado 0)
        UPDATE inventario_talonarios
        SET estado_preferencial = 0
        WHERE id = id_preferencial_actual AND cantidad_restante_preferencial <= 0;

        -- Activar siguiente lote pendiente (estado 2)
        UPDATE inventario_talonarios
        SET estado_preferencial = 1
        WHERE id = (
            SELECT id FROM inventario_talonarios
            WHERE cajero_id = NEW.cajero_id
              AND estado_preferencial = 2
              AND cantidad_restante_preferencial > 0
            ORDER BY id ASC
            LIMIT 1
        )
        AND NOT EXISTS (
            SELECT 1 FROM inventario_talonarios
            WHERE estado_preferencial = 1 AND cajero_id = NEW.cajero_id
        );
    END IF;

    -- Regulares: solo descontar del lote con estado 1
    IF NEW.cantidad_regulares REGEXP '^[0-9]+$' THEN
        UPDATE inventario_talonarios
        SET cantidad_restante_regular = cantidad_restante_regular - CAST(NEW.cantidad_regulares AS UNSIGNED)
        WHERE id = id_regular_actual;

        -- Si la cantidad restante llega a 0, marcar como agotado (estado 0)
        UPDATE inventario_talonarios
        SET estado_regular = 0
        WHERE id = id_regular_actual AND cantidad_restante_regular <= 0;

        -- Activar siguiente lote pendiente (estado 2)
        UPDATE inventario_talonarios
        SET estado_regular = 1
        WHERE id = (
            SELECT id FROM inventario_talonarios
            WHERE cajero_id = NEW.cajero_id
              AND estado_regular = 2
              AND cantidad_restante_regular > 0
            ORDER BY id ASC
            LIMIT 1
        )
        AND NOT EXISTS (
            SELECT 1 FROM inventario_talonarios
            WHERE estado_regular = 1 AND cajero_id = NEW.cajero_id
        );
    END IF;
END$$

DELIMITER ;
